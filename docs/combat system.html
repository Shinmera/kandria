<article><style>article{
    max-width: 800px;
    font-size: 12pt;
    font-family: sans-serif;
    margin: 3em auto;
}

article h1{
    text-align: center;
    font-size: 2em;
}

article img{
    margin: 0 auto;
    max-width: 100%;
}

article blockquote{
    border-left: 0.2em solid gray;
    margin-left: 1em;
    padding-left: 1em;
}

article figcaption{
    padding: 0.2em 1em;
    background: #E0E0E0;
}

article code{
    background: #F0F0F0;
    padding: 0 0.1em;
}

article .code-block{
    padding: 0.1em 0.5em;
}</style><h1 id="kandria combat system">Kandria Combat System</h1><p>This document describes the internals of how the combat and animation systems function. Kandria uses a combination of information provided natively by Aseprite, as well as an additional data file to describe extra per-animation and per-frame properties that the combat system needs to function.</p><p>For this reason, animation data is split across the following files:</p><ul><li><p><code>x.ase</code><br>Aseprite source file. This is only useful during development.</p></li><li><p><code>x.json</code><br>Aseprite exported JSON data. When exporting the animation from Aseprite, this file will be generated automatically. See <a class="cross-reference" href="#exporting from aseprite">exporting from aseprite</a></p></li><li><p><code>x.png</code><br>Aseprite exported sprite atlas. This is the packed atlas and contains all frames in a tight and efficient single image.</p></li><li><p><code>x.lisp</code><br>External animation data. This file is generated by the in-game animation editor and contains extra data relevant for combat. See <a class="cross-reference" href="#combat data format">combat data format</a>.</p></li></ul><p>For the most part you will be working within Aseprite and Kandria's editor. You should not have to modify the files manually often.</p><h2 id="combat mechanics">Combat Mechanics</h2><p>Any character in the game can be in several internal states, though for the purpose of this system, we'll focus on &quot;animated&quot; and &quot;normal&quot; states. In the normal state, animation is controlled tightly by the game and changes in actions and animations can occur at any point. Animations that are used in the normal state don't need any combat data, only basic animation data.</p><p>Every animation regardless of state has two properties:</p><ul><li><p><code>loop-to</code><br>When the animation reaches its end, it will loop back to this frame index. The index is zero-based. If no loop-to index is set, it instead uses</p></li><li><p><code>next</code><br>This designates which animation should be started if the current animation reaches its end and does not have a loop.</p></li></ul><p>For animations that are used in the animated state, the movement of the character is no longer in the player's hands but is instead governed by per-frame motion data. The per-frame data contains the following attributes:</p><ul><li><p><code>velocity</code><br>The added velocity of the character at this frame.</p></li><li><p><code>multiplier</code><br>The velocity multiplier at this frame. This is useful to gradually slow down or accelerate existing character velocity. Typically this is set to zero to make the <code>velocity</code> parameter be the effective velocity of the character.</p></li><li><p><code>hurtbox</code><br>The box relative to the character's position that designates where the attack would hit if colliding with another character.</p></li><li><p><code>knockback</code><br>The velocity that's added to a character at this frame if that character collides with the hurtbox.</p></li><li><p><code>damage</code><br>The amount of damage that's dealt to the character if the character collides with the hurtbox.</p></li><li><p><code>stun-time</code><br>The amount of time in seconds for which the other character is stunned for when colliding with the hurtbox.</p></li><li><p><code>flags</code></p><ul><li><p><code>interruptable</code><br>When set the animation can be interrupted by a collision with a hurtbox.</p></li><li><p><code>invincible</code><br>When set the character cannot be damaged by a collision with a hurtbox.</p></li><li><p><code>cancelable</code><br>When set the player can cancel the animation and instead switch to a different animation or state.</p></li></ul></li><li><p><code>effect</code><br>The name of an effect to trigger on this frame. Effects can cause sounds or particle effects.</p></li></ul><p>The animated state is used for attacks, getting hit, and dying.</p><p>In the player's case, animations can be buffered, meaning that the player can hit the button to initiate another animation while the current animation is playing. The buffered animation will play as soon as the current animation becomes cancelable or ends.</p><p>For general ideas about how the combat system is supposed to behave for the player, see the <a class="external-link" href="design.html">design document</a>'s combat section.</p><h2 id="combat data format">Combat Data Format</h2><p>The <code>x.lisp</code> file that contains the animation data is formatted using standard <a class="external-link" href="lisp crash course.html">Lisp syntax</a>. It is structured using property lists:</p><ul><li><p><code>:source</code></p></li><li><p><code>:animations</code></p><ul><li><p><code>name</code><br>The name as used by the game. This <em>must</em> correspond with the name of a tag in Aseprite and with the name used in the internal engine. Please see the <a class="external-link" href="https://docs.google.com/spreadsheets/d/1vJcVDEW0vasMw-FKumIrLA3jd2AYBKs6ZfTWOTXOC6k/edit">animation sheet</a> for the correct names.</p></li><li><p><code>:loop-to</code><br>See above.</p></li><li><p><code>:next</code><br>See above.</p></li></ul></li><li><p><code>:frames</code><br>These properties mostly correspond 1:1 with the above descriptions. Vectors are denoted by lists of numbers.</p><ul><li><p><code>:damage</code></p></li><li><p><code>:stun-time</code></p></li><li><p><code>:flags</code><br>The flags are expressed as a bit array in the (left to right) order of cancelable, invincible, interruptable.</p></li><li><p><code>:effect</code><br>The effect must correspond to the name of an effect as known by the game. Please see the &quot;</p></li><li><p><code>:velocity</code></p></li><li><p><code>:multiplier</code></p></li><li><p><code>:knockback</code></p></li><li><p><code>:hurtbox</code></p></li></ul></li></ul><p>Typically you will not want to edit this file manually and instead use the <a class="external-link" href="editor.html">animation editor</a>.</p><h2 id="exporting from aseprite">Exporting from Aseprite</h2><p>When exporting from Aseprite to update animations, please choose &quot;Export Sprite Sheet&quot; with the following options:</p><ul><li><p>Layout</p><ul><li><p>Sheet Type: Packed</p></li><li><p>Constraints: None</p></li></ul></li><li><p>Borders</p><ul><li><p>Border padding: 0</p></li><li><p>Spacing: 1</p></li><li><p>Inner Padding: 0</p></li><li><p>Trim Cels: checked</p></li></ul></li><li><p>Output</p><ul><li><p>Output File: checked<br>Name: <code>x.png</code></p></li><li><p>JSON Data: checked<br>Name: <code>x.json</code><br>Type: Array<br>Filename: <code>{tagframe} {tag}</code></p></li></ul></li></ul><p>You can also do this for most files in an automated fashion by just running the following from the Portacle REPL:</p><code style="display:block" class="code-block"><pre>(kandria::compile-resources T T)</pre></code></article>